<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>ICMP: Протокол управления сообщениями Internet</TITLE>
</HEAD>
<BODY>
<div>
<P><SMALL><A href="index.html"><IMG border=0 height=20 src="contents.jpg"
width=94></A><A href="index.html"><IMG border=0 height=20 src="begin.jpg"
width=68></A><A href="glava7.html"><IMG border=0 height=20 src="forward.jpg"
width=68></A><A href="glava5.html"><IMG border=0 height=20 src="back_b.jpg"
width=68></A><A href="index.html"><IMG border=0 height=20 src="index.jpg" 
width=68></A></SMALL></P><FONT face=Arial size=4>
<P><A name=t060000></A>Глава 6 ICMP: протокол управления сообщениями 
Internet</P></FONT><FONT face=Arial><FONT size=3><U>
<P><B><A name=t061000></A>Введение</P></B></U></FONT>
<P><SMALL>Обычно считается, что ICMP это часть IP уровня. С его помощью 
передаются сообщения об ошибках и сообщения о возникновении условий и ситуаций, 
которые требуют к себе особого внимания. ICMP сообщения обрабатываются IP 
уровнем или более высокими уровнями (TCP или UDP). При появлении некоторых ICMP 
сообщений генерируются сообщения об ошибках, которые передаются пользовательским 
процессам. </SMALL></P>
<P><SMALL>ICMP сообщения передаются внутри IP датаграмм, как показано на рисунке 
6.1.<A name=t061001></A></SMALL></P></FONT>
<P align=center><SMALL><IMG height=75 src="t6_1.jpg" width=314></SMALL></P><FONT 
face=Arial>
<P align=center><SMALL>Рисунок 6.1 Инкапсуляция ICMP сообщений в IP 
датаграммы.</SMALL></P>
<P>&nbsp;</P>
<P><SMALL>Официальная спецификация ICMP находится в RFC 792 [<A 
name=t061002></A>Postel 1981b]. </SMALL></P>
<P><SMALL>На рисунке 6.2 показан формат ICMP сообщения. Первые 4 байта одинаковы 
для всех сообщений, однако остальные отличаются в зависимости от типа сообщения. 
Мы будем показывать точный формат каждого сообщения, по мере того как будем их 
описывать. </SMALL></P>
<P><SMALL>Существует 15 различных значений для поля типа (type), которые 
указывают на конкретныей тип ICMP сообщения. Для некоторых ICMP сообщений 
используются различные значения в поле кода (code), подобным образом 
осуществляется дальнейшее подразделение ICMP сообщений. </SMALL></P>
<P><SMALL>Поле <A name=t061003></A>контрольной суммы (checksum) охватывает ICMP 
сообщения целиком. Алгоритм, используемый при этом, такой же как тот, что был 
описан в разделе <A href="glava3.html#t032000">"IP заголовок"</A> главы 3 при
расчете контрольной суммы IP заголовка. Контрольная сумма ICMP присутствует 
всегда.<A name=t061004></A></SMALL></P></FONT>
<P align=center><SMALL><IMG height=148 src="t6_2.jpg" 
width=480></SMALL></P><FONT face=Arial>
<P align=center><SMALL>Рисунок 6.2 ICMP сообщение.</SMALL></P>
<P>&nbsp;</P>
<P><SMALL>В этой главе мы рассмотрим ICMP сообщения в целом, некоторые из них 
подробно: запрос и отклик маски адреса, запрос и отклик временной марки и 
сообщение о недоступности порта. В <A href="glava7.html">главе 7</A> мы обсудим, с
использованием программы Ping, эхо запрос и эхо отклик, а в <A 
href="glava9.html">главе 9</A> рассмотрим ICMP сообщения, связанные с IP
маршрутизацией.</SMALL></P><FONT size=3><U><B>
<P><A name=t062000></A>Типы сообщений ICMP</P></B></U></FONT>
<P><SMALL>На рисунке 6.3 приведены возможные типы ICMP сообщений, как они 
определяются полями типа (type) и кода (code). </SMALL></P>
<P><SMALL>Последние две колонки на рисунке указывают, является ли ICMP сообщение 
запросом (query) или сообщением об ошибке (error). Подобное разделение 
необходимо, потому что сообщения об ошибках ICMP иногда обрабатываются 
специальным образом. Например, ICMP сообщение об ошибке никогда не генерируется 
в ответ на ICMP сообщение об ошибке. (Если не придерживаться этого правила, то 
ошибка будет генерироваться на ошибку до бесконечности.) </SMALL></P>
<P><SMALL>Когда посылается ICMP сообщение об ошибке, оно всегда содержит IP 
заголовок и первые 8 байт IP датаграммы, которая вызвала генерацию ICMP ошибки. 
Это позволяет принимающему ICMP модулю установить соответствие между полученным 
сообщением, одним из конкретных протоколов (TCP или UDP из <A 
name=t062003></A>поля протоколов в IP заголовке) и с одним из конкретных 
пользовательских процессов (с помощью номера порта TCP или UDP, который 
содержится в TCP или UDP заголовке в первых 8 байтах IP датаграммы). В разделе 
<A href="#t065000">"ICMP ошибка недоступности порта (ICMP Port Unreachable 
Error)"</A> главы 6 мы рассмотрим это более подробно. </SMALL></P>
<P><SMALL>Сообщение об ошибке ICMP никогда не генерируется в ответ на:</SMALL> 
<OL>
  <LI><SMALL>ICMP сообщение об ошибке. (ICMP сообщение об ошибке, однако, может 
  быть сгенерировано в ответ на ICMP запрос.)</SMALL> 
  <LI><SMALL>Датаграмму, направляющуюся на широковещательный IP адрес (рисунок 
  3.9) или групповой адрес IP (адрес класса D, рисунок 1.5).</SMALL> 
  <LI><SMALL>Датаграмму, которая посылается широковещательным запросом на 
  канальном уровне.</SMALL> 
  <LI><SMALL>Фрагмент, который не является первым. (Мы опишем фрагментацию в 
  разделе <A href="glava11.html#t115000">"Фрагментация IP"</A> главы 11.) </SMALL>
  <LI><SMALL>Датаграмму, адрес источника которой не указывает на конкретный 
  хост. Это означает, что адрес источника не может быть нулевым, <A 
  name=t062002></A>loopback адресом, широковещательным или групповым адресом.<A 
  name=t062001></A></SMALL> </LI></OL>
<P>&nbsp;</P></FONT>
<TABLE border=1 borderColor=#000000 cellPadding=5 cellSpacing=1 width=732>
  <TBODY>
  <TR>
    <TD bgColor=#ffffff vAlign=top width="7%">
      <P align=center><SMALL><FONT face=Arial>тип</FONT></SMALL></P></TD>
    <TD bgColor=#ffffff vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>код</SMALL></FONT></P></TD>
    <TD bgColor=#ffffff vAlign=top width="64%"><FONT face=Arial>
      <P align=center><SMALL>Описание</SMALL></FONT></P></TD>
    <TD bgColor=#ffffff vAlign=top width="11%"><FONT face=Arial>
      <P align=center><SMALL>запрос</SMALL></FONT></P></TD>
    <TD bgColor=#ffffff vAlign=top width="11%"><FONT face=Arial>
      <P align=center><SMALL>ошибка</SMALL></FONT></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>эхо-отклик 
      (отклик-Ping, <A href="glava7.html">глава 7</A>)</SMALL></FONT></TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD>
    <TD vAlign=top width="11%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>3</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>назначение 
      недоступно:</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>сеть недоступна - 
      network unreachable (раздел <A href="glava9.html#t093000">"ICMP ошибки о
      недоступности хоста и сети"</A> главы 9)</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>1</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>хост недоступен - host 
      unreachable (раздел <A href="glava9.html#t093000">"ICMP ошибки о
      недоступности хоста и сети"</A> главы 9)</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>2</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>протокол недоступен - 
      protocol unreachable</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>3</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>порт недоступен - port 
      unreachable (раздел <A href="#t065000">"ICMP ошибка недоступности порта 
      (ICMP Port Unreachable Error)"</A> главы 6)</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>4</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>необходима 
      фрагментация, однако установлен бит &#8220;не фрагментировать&#8221;- fragmentation 
      needed but don&#8217;t-fragment bit set (раздел <A 
      href="glava11.html#t116000">"ICMP ошибки о недоступности"</A> главы
      11)</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>5</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>не работает 
      маршрутизация от источника - source route failed (глава 8, раздел <A 
      href="glava8.html#t085000">"Опция IP маршрутизации от
      источника"</A>)</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>6</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>неизвестна сеть 
      назначения - destination network unknown</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>7</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>неизвестен хост 
      назначения - destination host unknown</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>8</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>хост источник 
      изолирован - source host isolated</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>9</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>сеть назначения закрыта 
      администратором - destination network administrativrly 
      prohibited</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>10</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>хост назначения закрыт 
      администратором - destination host administrativrly 
      prohibited</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>11</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>сеть недоступна для TOS 
      - network unreachable for TOS (глава 9, раздел <A 
      href="glava9.html#t093000">"ICMP ошибки о недоступности хоста и
      сети"</A>)</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>12</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>хост недоступен для TOS 
      - host unreachable for TOS (глава 9, раздел <A 
      href="glava9.html#t093000">"ICMP ошибки о недоступности хоста и
      сети"</A>)</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>13</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>связь административно 
      закрыта путем фильтрации - communication administratively prohibited by 
      filtering </SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>14</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>нарушено старшинство 
      для хоста - host precedence violation </SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>15</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>старшинство разъединено 
      - precedence cutoff in effect </SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>4</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>подавление источника 
      (элементарное управление потоком данных) - source quench (глава 11, раздел 
      <A href="glava11.html#t11B000">"ICMP ошибка подавления
      источника"</A>)</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>5</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>перенаправление - 
      redirect (глава 11, раздел <A href="glava11.html#t11B000">"ICMP ошибка
      подавления источника"</A>): </SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>перенаправление в сеть 
      - redirect for network </SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>1</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>перенаправление в хост 
      - redirect for host</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>2</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>перенаправление для 
      типа сервиса и сети - redirect for type-of-service and 
      network</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>3</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>перенаправление для 
      типа сервиса и хоста - redirect for type-of-service and 
    host</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>8</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>эхо запрос - echo 
      request (Ping запрос, <A href="glava7.html">глава 7</A>)</SMALL></FONT></TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD>
    <TD vAlign=top width="11%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>9</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>объявление 
      маршрутизатора - router advertisement (глава 9, раздел <A href="glava9.html#t096000">"ICMP сообщения поиска
      маршрутизатора"</A>)</SMALL></FONT></TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD>
    <TD vAlign=top width="11%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>10</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>запрос к маршрутизатору 
      - router solicitation (глава 9, раздел <A href="glava9.html#t096000">"ICMP
      сообщения поиска маршрутизатора"</A>)</SMALL></FONT></TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD>
    <TD vAlign=top width="11%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>11</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>время истекло - time 
      exceeded:</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>время жизни стало 
      равным 0 в процессе передачи - time-to-live equals 0 during transit 
      (Traceroute, <A href="glava8.html">глава 8</A>)</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>1</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>время жизни стало 
      равным 0 в процессе повторной сборки - time-to-live equals 0 during 
      reassembly (глава 11, раздел <A href="glava11.html#t115000">"Фрагментация
      IP"</A>)</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>12</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>проблемы с параметрами 
      - parameter problem:</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>неверный IP заголовок - 
      IP header bad</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>1</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>отсутствует необходимая 
      опция - required option missing</SMALL></FONT></TD>
    <TD vAlign=top width="11%">&nbsp;</TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>13</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>запрос временной марки 
      - timestamp request (глава 6, раздел <A href="#t064000">"ICMP запрос и 
      отклик временной марки"</A>)</SMALL></FONT></TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD>
    <TD vAlign=top width="11%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>14</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>отклик с временной 
      маркой - timestamp reply (глава 6, раздел <A href="#t064000">"ICMP запрос 
      и отклик временной марки"</A>)</SMALL></FONT></TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD>
    <TD vAlign=top width="11%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>15</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>информационный запрос - 
      information request </SMALL></FONT></TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD>
    <TD vAlign=top width="11%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>16</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>информационный отклик - 
      information reply </SMALL></FONT></TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD>
    <TD vAlign=top width="11%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>17</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>запрос маски адреса - 
      address mask request (глава 6, раздел <A href="#t063000">"ICMP запрос и 
      отклик маски адреса"</A>)</SMALL></FONT></TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD>
    <TD vAlign=top width="11%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>18</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="64%"><FONT face=Arial><SMALL>отклик с маской адреса 
      - address mask reply (глава 6, раздел <A href="#t063000">"ICMP запрос и 
      отклик маски адреса"</A>)</SMALL></FONT></TD>
    <TD vAlign=top width="11%"><FONT face=Symbol>
      <P align=center><SMALL>·</FONT><FONT face=Arial> </FONT></SMALL></P></TD>
    <TD vAlign=top width="11%">&nbsp;</TD></TR></TBODY></TABLE><FONT face=Arial>
<P><SMALL>Рисунок 6.3 Типы сообщений ICMP.</SMALL></P>
<P>&nbsp;</P>
<P><SMALL>Эти правила введены для того, чтобы предотвратить лавинообразный рост 
количества широковещательных сообщений, который может произойти, если ICMP 
сообщения об ошибках будут отправляться в ответ на широковещательные 
пакеты.</SMALL></P><FONT size=3><U><B>
<P><A name=t063000></A>ICMP запрос и отклик маски адреса</P></B></U></FONT>
<P><SMALL>ICMP запрос маски адреса используется бездисковыми системами, чтобы 
получить маску подсети (глава 3, раздел <A href="glava3.html#t035000">"Маска
подсети"</A>) во время загрузки. Система посылает широковещательный ICMP запрос. 
(Это напоминает то, как бездисковые системы с использованием RARP получают свои 
IP адреса во время загрузки.) Альтернативный метод для бездисковых систем 
получить маски своих подсетей - протокол BOOTP, о котором рассказано в <A 
href="glava16.html">главе 16</A>. На рисунке 6.4 показан формат ICMP запроса и
отклика маски адреса.<A name=t063001></A></SMALL></P>
<P>&nbsp;</P></FONT>
<P align=center><SMALL><IMG height=128 src="t6_4.jpg" 
width=518></SMALL></P><FONT face=Arial>
<P align=center><SMALL>Рисунок 6.4 ICMP запрос и отклик маски 
адреса.</SMALL></P>
<P>&nbsp;</P>
<P><SMALL>Поля идентификатора и номера последовательности в ICMP сообщении могут 
быть установлены по выбору отправителя, эти же значения будут возвращены в 
отклике. Именно таким образом отправитель идентифицирует отклик на свой запрос. 
</SMALL></P>
<P><SMALL>Мы можем написать простую программу (которая называется <A 
name=t063002></A>icmpaddrmask), которая выдает ICMP запрос маски адреса и 
печатает все отклики. Обычно, запрос отправляется на <A 
name=t063003></A>широковещательный адрес, мы поступим точно так же. Адрес 
назначения (140.252.13.63) это широковещательный адрес для подсети 140.252.13.32 
(см. рисунок 3.12).</SMALL></P>
<P>&nbsp;</P></FONT><FONT face="Courier New" size=2>
<P>sun % <B>icmpaddrmask 140.252.13.63</B><BR>received mask = ffffffe0, from 
140.252.13.33 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; от самого 
себя<BR>received mask = ffffffe0, from 140.252.13.35 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; от bsdi<BR>received mask = 
ffff0000, from 140.252.13.34 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; от 
svr4<BR></P></FONT><FONT face=Arial>
<P>&nbsp;</P>
<P><SMALL>Первое, на что стоит обратить внимание в выводе программы, это то, что 
значение, возвращенное от svr4, неверно. Это произошло из-за того, что <A 
name=t063004></A>SVR4 возвращает общую маску подсети класса В, подразумевающую, 
что деление на подсети не осуществлено, даже несмотря на то что интерфейс svr4 
сконфигурирован с правильной маской подсети:</SMALL></P>
<P>&nbsp;</P></FONT><FONT face="Courier New" size=2>
<P>svr4 % <B>ifconfig emd0</B><BR>emd0: flags=23&lt;UP, BROADCAST, 
NOTRAILERS.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inet 140.252.13.34 netmask 
ffffffe0 broadcast 140.252.13.63<BR></P></FONT><FONT face=Arial>
<P>&nbsp;</P>
<P><SMALL>Это одна из известных ошибок SVR4 возникающая при обработке ICMP 
запросов маски адреса. </SMALL></P>
<P><SMALL>Мы рассмотрим обмен пакетами для хоста bsdi, используя tcpdump. Вывод 
показан на рисунке 6.5. Была использована опция <A name=t063005></A>-e, которая 
позволяет посмотреть аппаратные адреса.<A name=t063006></A></SMALL></P>
<P>&nbsp;</P></FONT><FONT face="Courier New" size=2>
<P>1 0.0 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
8:0:20:3:f6:42 ff:ff:ff:ff:ff:ff ip 60: 
<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
sun &gt; 140.252.13.63: icmp: address mask request<BR>2 0.00 
(0.00)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0:0:c0:6f:2d:40 ff:ff:ff:ff:ff:ff ip 46: 
<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
bsdi &gt; sun: icmp: address mask is 0xffffffe0<BR>3 0.01 
(0.01)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0:0:c0:6f:2d:40 8:0:20:3:f6:42 ip 60: 
<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
svr4 &gt; sun: icmp: address mask is 0xffff0000<BR></P></FONT><FONT face=Arial>
<P>&nbsp;</P>
<P><SMALL>Рисунок 6.5 ICMP запрос маски адреса, отправленный на 
широковещательный адрес.</SMALL></P>
<P>&nbsp;</P>
<P><SMALL>Обратите внимание на то, что посылающий хост, sun, принимает ICMP 
отклик (строка вывода с комментарием "от самого себя", которая была показана 
ранее), даже если "в кабеле" ничего не было. Это основная характеристика 
широковещательных запросов: посылающий хост принимает копию широковещательного 
пакета через внутренний механизм loopback. Так как по определению термин 
"широковещательный запрос" означает все хосты в локальной сети, сюда же 
включается и посылающий хост. (Если обратиться к рисунку 2.4, можно увидить, что 
драйвер Ethernet, определив, что адрес назначения является широковещательным, 
посылает пакет в сеть и копирует его в интерфейс loopback.) </SMALL></P>
<P><SMALL>Затем bsdi отправляет широковещательным запросом отклик, тогда как 
svr4 посылает отклик только тому, кто отправил запрос. Обычно отклик должен быть 
персональным, если только IP адрес источника в запросе не установлен в 0.0.0.0, 
отправка откликов на широковещательный адрес это ошибка, допущенная в <A 
name=t063007></A>BSD/386.</SMALL></P>
<P>&nbsp;</P><FONT size=1>
<P></FONT><FONT size=2><FONT color=#0000a0>Требования к хостам <A 
name=t063008></A>Host Requirements RFC гласят, что система не должна отправлять 
отклик о маске адреса, если она не является полномочным агентом для рассылки 
масок адресов. (Чтобы являтьься полномочным агентом и рассылать подобные 
отклики, система должна быть специально сконфигурирована. (См. <A 
href="glavaE.html">приложение Е</A>.) Однако, как мы видим из этого примера,
большинство реализаций посылают отклик в ответ на полученный запрос. Иногда 
хосты даже посылают неверные отклики!</FONT></P></FONT>
<P>&nbsp;</P>
<P><SMALL>Обратимся к следующему примеру. Мы посылаем запрос о маске адреса на 
свой собственный IP адрес и на loopback адрес:</SMALL></P>
<P>&nbsp;</P></FONT><FONT face="Courier New" size=1>
<P></FONT><FONT face="Courier New" size=2>sun % <B>icmpaddrmask 
sun<BR></B>received mask = ff000000, from 140.252.13.33<BR><BR>sun % 
<B>icmpaddrmask localhost<BR></B>received mask = ff000000, from 
127.0.0.1</FONT><FONT face=Arial>&nbsp;</P>
<P>&nbsp;</P>
<P><SMALL>В обоих случаях возвращенная маска адреса соответствует адресу 
loopback, адресу 127.0.0.1 сети класса А. Снова обратившись к рисунку 2.4 мы 
увидим, что IP датаграммы, посланные на собственный IP адрес хоста 
(140.252.13.33 в данном примере), в действительности посылаются на <A 
name=t063009></A>loopback интерфейс. ICMP отклик о маске адреса должен 
соответствовать маске подсети интерфейса, на которой был принят запрос (при этом 
хост с несколькими интерфейсами может иметь различные маски подсети для каждого 
интерфейса), а в нашем случае оба запроса получены с интерфейса 
loopback.</SMALL></P><FONT size=3><U><B>
<P><A name=t064000></A>ICMP запрос и отклик временной марки</P></B></U></FONT>
<P><SMALL>ICMP запрос временной марки позволяет системе запросить другую систему 
о текущем времени. Рекомендуемое значение, которое должно быть возвращено, это 
количество миллисекунд, которые прошли с полуночи в формате UTC, (<A 
name=t064001></A>Универсальное согласованное время - Coordinated Universal 
Time). (В старых руководствах UTC называется Среднее время по Гринвичу - 
Greenwich Mean Time.) Одна из основных особенностей ICMP сообщения заключается в 
том, что оно предоставляет время в с точностью до миллисекунд, тогда как другие 
методы используемые для получения времени от удаленных систем (например, команда 
<A name=t064002></A>rdate, существующая в некоторых UNIX системах) предоставляют 
время с точностью до секунд. Недостаток заключается в том, что сообщается только 
время, прошедшее с полуночи, - запрашивающая система должена знать текущую дату. 
На рисунке 6.6 показан формат ICMP запроса и формат ICMP отклика временной 
марки.<A name=t064003></A></SMALL></P>
<P>&nbsp;</P></FONT>
<P align=center><SMALL><IMG height=207 src="t6_6.jpg" 
width=516></SMALL></P><FONT face=Arial>
<P align=center><SMALL>Рисунок 6.6 ICMP запрос и отклик временной 
марки.</SMALL></P>
<P>&nbsp;</P>
<P><SMALL>Запрашивающий заполняет исходную временную марку и отправляет запрос. 
Отвечающая система заполняет временную марку приема, когда получает запрос, и 
временную марку передачи, когда отправляет отклик. Большинство реализаций 
устанавливают в два последних поля одно и то же значение. (Причина, по которой 
существуют три поля, заключается в том, что отправителю необходимо вычислить 
время, которое потребовалось на отправку запроса, и отдельно рассчитать время, 
которое потребуется на отправку отклика.)</SMALL></P><FONT size=3><I><B>
<P>Примеры</P></B></I></FONT>
<P><SMALL>Воспользуемся простой программой (которая называется <A 
name=t064004></A>icmptime), которая посылает ICMP запрос временной марки и 
печатает полученный отклик. Запустим эту программу в нашей маленькой 
сети:</SMALL></P>
<P>&nbsp;</P></FONT><FONT face="Courier New" size=1>
<P></FONT><FONT face="Courier New" size=2>sun %<B> icmptime bsdi<BR></B>orig = 
83573336, recv = 83573330, xmit = 83573330, rtt = 2 ms<BR>difference = -6 
ms<BR><BR>sun % <B>icmptime bsdi<BR></B>orig = 83577987, recv = 83577980, xmit = 
83577980, rtt = 2 ms<BR>difference = -7 ms</FONT><FONT face=Arial>&nbsp;</P>
<P>&nbsp;</P>
<P><SMALL>Программа выдала три временные марки из ICMP сообщения: исходную 
(orig), приема (recv) и передачи (xmit). Из этого и следующих примеров видно, 
что все хосты установили временные марки приема и передачи в одно и то же 
значение. </SMALL></P>
<P><SMALL><A name=t064005></A>Также мы рассчитали время возврата (rtt) , которое 
рассчитывается как время, когда был принят отклик, минус время, когда был 
отправлен запрос. difference - это временная марка приема минус исходная 
временная марка. На рисунке 6.7 показана взаимосвязь между этими значениями.<A 
name=t064006></A></SMALL></P></FONT>
<P align=center><SMALL><IMG height=75 src="t6_7.jpg" width=441></SMALL></P><FONT 
face=Arial>
<P align=center><SMALL>Рисунок 6.7 Взаимосвязь между значениями, напечатанными 
программой icmptime.</SMALL></P>
<P>&nbsp;</P>
<P><SMALL>Если принять за истину то, что одна половина RTT отводится под запрос, 
а другая половина под отклик, тогда <A name=t064007></A>часы отправителя должны 
быть настроены как difference минус половина RTT, чтобы иметь то же самое время, 
как у хоста к которому отправляется запрос. В предыдущем примере часы 
bsdi</FONT> <FONT face=Arial>отставали на 7 и 8 миллисекунд от часов sun. 
</SMALL></P>
<P><SMALL>Так как временная марка является количеством миллисекунд после 
полуночи, UTC должны быть всегда меньше чем 86400000 (24х60х60х1000). Эти 
примеры были исполнены сразу после 16:00 во временной зоне имеющей отставание на 
7 часов от UTC, таким образом, приемлемыми являются значения больше чем 82800000 
(2300 часов). </SMALL></P>
<P><SMALL>Если мы запустим эту программу несколько раз на хост bsdi, то увидим, 
что последние цифры во временной марке передачи и приема всегда равны нулю. Это 
происходит из-за того, что программный релиз (Version 0.9.4) имеет часы с 
точностью 10 миллисекунд. (Мы опишем это в <A href="glavaB.html">приложении
В</A>.) </SMALL></P>
<P><SMALL>Если мы запустим программу дважды на хост svr4, то увидим что уже три 
младшие цифры во временной марке <A name=t064008></A>SVR4 равны 
нулю:</SMALL></P>
<P>&nbsp;</P></FONT><FONT face="Courier New" size=1>
<P></FONT><FONT face="Courier New" size=2>sun % <B>icmptime svr4<BR></B>orig = 
83588210, recv = 83588000, xmit = 83588000, rtt = 4 ms<BR>difference = -210 
ms<BR><BR>sun % <B>icmptime svr4<BR></B>orig = 83591547, recv = 83591000, xmit = 
83591000, rtt = 4 ms<BR>difference = -547 ms</FONT><FONT face=Arial>&nbsp;</P>
<P><SMALL>По каким-то причинам SVR4 не предоставляет разрешение времени с 
точностью до миллисекунд при использовании временной марки ICMP. Подобная 
неточность делает расчет разницы во времени бесполезным, если разговор идет о 
миллисекундах. </SMALL></P>
<P><SMALL>Если мы обратимся к двум другим хостам в подсети 140.252.1, то увидим, 
что установка одних часов отличается от установки часов sun на 3,7 секунды, а 
других на 75 секунд:</SMALL></P></FONT><FONT face="Courier New" size=1>
<P></FONT><FONT face="Courier New" size=2>sun %<B> icmptime gemini<BR></B>orig = 
83601883, recv = 83598140, xmit = 83598140, rtt = 247 ms<BR>difference = -3743 
ms<BR><BR>sun % <B>icmptime aix<BR></B>orig = 83606768, recv = 83532183, xmit = 
83532183, rtt = 253 ms<BR>difference = -74585 ms</FONT><FONT 
face=Arial>&nbsp;</P>
<P><SMALL>Другой интересный пример может быть получен при обращении к 
маршрутизатору gateway (маршрутизатор Cisco). Из примера видно, что если система 
возвращает нестандартное значение временной марки (отличающееся от количества 
миллисекунд после полуночи, UTC), старшие биты в 32-битной временной марке 
устанавливаются в единицу. Наша программа определяет это и печатает временные 
марки приема и передачи в треугольных скобках (после установки старших битов в 
ноль). Мы можем рассчитать разницу между исходной временной маркой и временной 
маркой приема.</SMALL></P></FONT><FONT face="Courier New" size=1>
<P></FONT><FONT face="Courier New" size=2>sun %<B> icmptime gateway<BR></B>orig 
= 83620811, recv = &lt;4871036&gt;, xmit = &lt;4871036&gt;, rtt = 220 
ms<BR><BR>sun % <B>icmptime gateway<BR></B>orig = 83641007, recv = 
&lt;4891232&gt;, xmit = &lt;4891232&gt;, rtt = 213 ms</FONT><FONT 
face=Arial>&nbsp;</P>
<P>&nbsp;</P>
<P><SMALL>Если запустить нашу программу на этот хост несколько раз, то можно 
заметить, что полученные значения имеют точность до миллисекунд и содержит 
количество миллисекунд с какой-то начальной точки, однако начальная точка не 
полночь, UTC. (Это может быть, например, счетчик, который увеличивается на 
единицу каждую миллисекунду с момента загрузки маршрутизатора.) </SMALL></P>
<P><SMALL>И в качестве последнего примера сравним часы sun с часами системы, 
которые считаются абсолютно точными - сервер NTP. (Мы расскажем о протоколе 
сетевого времени <A name=t064009></A>NTP - Network Time Protocol, 
ниже.)</SMALL></P>
<P>&nbsp;</P></FONT><FONT face="Courier New" size=1>
<P></FONT><FONT face="Courier New" size=2>sun % <B>icmptime 
clock.llnl.gov<BR></B>orig = 83662791, recv = 83662919, xmit = 83662919, rtt = 
359 ms<BR>difference = 128 ms<BR><BR>sun %<B> icmptime 
clock.llnl.gov<BR></B>orig = 83670425, recv = 83670559, xmit = 83670559, rtt = 
345 ms<BR>difference = 134 ms</FONT><FONT face=Arial>&nbsp;</P>
<P>&nbsp;</P>
<P><SMALL>Если вычесть из разницы (difference) половину RTT, то можно будет 
сказать, что часы sun торопятся на величину в диапазоне 51,5 - 38,5 
миллисекунды.</SMALL></P><FONT size=3><I><B>
<P>Другие возможные варианты</P></B></I></FONT>
<P><SMALL>Существуют другие способы получить время и дату. </SMALL>
<OL>
  <LI><SMALL>Мы описали сервис дневного времени и сервис времени в разделе <A 
  href="glava1.html#t01C000">"Стандартные простые сервисы"</A> главы 1. Первый
  возвращает текущую дату и время в формате, понятном для человека - в виде 
  строк ACSII символов. Мы можем проверить работу этого сервиса с использованием 
  команды <A name=t064010></A>telnet:</SMALL></FONT><FONT face="Courier New" 
  size=2>
  <P>sun %<B> telnet bsdi daytime</B><BR>Trying 140.252.13.35 ...<BR>Connected 
  to bsdi.<BR>Escape character is '^]'. 
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
  первые три строки - вывод Telnet клиента<BR>Wed Feb 3 16:38:33 1993 
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
  это вывод сервиса дневного времени<BR>Connection closed by foreign 
  host.&nbsp;&nbsp;&nbsp;&nbsp; это опять вывод Telnet 
  клиента<BR></P></FONT><FONT face=Arial>
  <P><SMALL>Сервер времени возвращает 32-битное двоичное значение, содержащее 
  количество секунд после полуночи 1 января 1900 года, UTC. (Команда <A 
  name=t064011></A>rdate, которую мы упоминали ранее, использует сервис времени 
  TCP.)</SMALL></P>
  <LI><SMALL>Для получения более точного времени используется протокол сетевого 
  времени (<A name=t064012></A>NTP - Network Time Protocol), который описан в 
  RFC 1305 [<A name=t064013></A>Mills 1992]. Этот протокол использует 
  определенную технику поддержания точности часов для группы систем в локальной 
  или глобальной сети с точностью до миллисекунды. Для более подробного изучения 
  функционирования этого протокола, необходимо обратиться к RFC.</SMALL> 
  <LI><SMALL><A name=t064014></A>Open Software Foundation (OSF) <A 
  name=t064015></A>Distributed Computing Environment (DCE) определяет <A 
  name=t064016></A>сервис распределенного времени (DTS - Distributed Time 
  Service), который также осуществляет синхронизацию часов между хостами. <A 
  name=t064017></A>[Rosenberg, Kenney, and Fisher 1992] более подробно описывает 
  этот сервис.</SMALL> 
  <LI><SMALL>В Unix системах Berkeley существует демон <A 
  name=t064018></A>timed(8) , который используется для синхронизации часов 
  систем, находящихся в локальной сети. В отличие от NTP и DTS, timed не 
  работает в глобальных сетях.</SMALL> </LI></OL>
<P>&nbsp;</P><FONT size=3><U><B>
<P><A name=t065000></A>ICMP ошибка недоступности порта (ICMP Port Unreachable 
Error) </P></B></U></FONT>
<P><SMALL>В двух последних разделах описаны запросы ICMP - маски адреса, и 
запросы и отклики временной марки. Сейчас мы рассмотрим ICMP сообщения об 
ошибках, а именно: сообщение о недоступности порта, подкод сообщения ICMP о 
недоступности пункта назначения. Также рассмотрим дополнительную информацию, 
которая возвращается в ICMP сообщении об ошибке. Для этого воспользуемся UDP (<A href="glava11.html">глава 11</A>). </SMALL></P>
<P><SMALL>Если UDP принимает датаграмму, порт назначения которой не 
соответствует порту, который обслуживается каким-либо процессом, UDP выдает ICMP 
сообщение о недоступности порта. Попробуем получить ошибку недоступности порта с 
использованием TFTP клиента. (<A name=t065006></A>TFTP подробно описан в <A href="glva15.html">главе 15</A>.) </SMALL></P>
<P><SMALL>TFTP сервер использует заранее-известный UDP порт 69. Однако 
большинство программ TFTP клиента позволяют указать другой порт с помощью 
команды connect. В данном случае мы указали порт 8888: </SMALL></P>
<P>&nbsp;</P></FONT><FONT face="Courier New" size=2>
<P>bsdi % <B>tftp</B><BR>tftp&gt; <B>connect svr4 8888 
</B>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; указываем имя сервера и 
номер порта<BR>tftp&gt; <B>get temp.foo 
</B>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
пробуем получить файл<BR>Transfer timed out. 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
25 секунд спустя истекает время таймера<BR>tftp&gt; 
<B>quit</B><BR></P></FONT><FONT face=Arial>
<P>&nbsp;</P>
<P><SMALL>Команда connect сохраняет имя хоста, с которым необходимо установить 
соединение, и номер порта на этом хосте для дальнейшего использования командой 
get. После того как введена команда get, UDP датаграмма посылается на порт 8888 
хоста svr4. На рисунке 6.8 показан вывод команды <A name=t065012></A>tcpdump, 
иллюстрирующий обмен пакетами. </SMALL></P>
<P><SMALL>Перед тем как послать UDP датаграмму на svr4, отправляется ARP запрос, 
для того чтобы определить аппаратный адрес (строка 1). Возвращается ARP отклик 
(строка 2), после чего отправляются UDP датаграммы (строка 3). (Мы оставили ARP 
запрос-отклик в выводе команды tcpdump, чтобы напомнить Вам, что этот обмен 
необходим перед отправкой первой IP датаграммы с одного хоста на другой. В 
следующих примерах мы не будем приводить ARP обмен.)<A name=t065003></A> 
</SMALL></P>
<P>&nbsp;</P></FONT><FONT face="Courier New" size=2>
<P>1&nbsp;&nbsp; 0.0 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
arp who-has svr4 tell bsdi<BR>2&nbsp;&nbsp; 0.002050 
(0.0020)&nbsp;&nbsp;&nbsp;&nbsp; arp reply svr4 is-at 
0:0:c0:c2:9b:26<BR><BR>3&nbsp;&nbsp; 0.002723 (0.0007)&nbsp;&nbsp;&nbsp;&nbsp; 
bsdi.2924 &gt; svr4.8888: udp 20<BR>4&nbsp;&nbsp; 0.006399 
(0.0037)&nbsp;&nbsp;&nbsp;&nbsp; svr4 &gt; bsdi: icmp: svr4 udp port 8888 
unreachable<BR><BR>5&nbsp;&nbsp; 5.000776 (4.9944)&nbsp;&nbsp;&nbsp;&nbsp; 
bsdi.2924 &gt; svr4.8888: udp 20<BR>6&nbsp;&nbsp; 5.004304 
(0.0035)&nbsp;&nbsp;&nbsp;&nbsp; svr4 &gt; bsdi: icmp: svr4 udp port 8888 
unreachable<BR><BR>7&nbsp; 10.000887 (4.9966)&nbsp;&nbsp;&nbsp;&nbsp; bsdi.2924 
&gt; svr4.8888: udp 20<BR>8&nbsp; 10.004416 (0.0035)&nbsp;&nbsp;&nbsp;&nbsp; 
svr4 &gt; bsdi: icmp: svr4 udp port 8888 unreachable<BR><BR>9&nbsp; 15.001014 
(4.9966)&nbsp;&nbsp;&nbsp;&nbsp; bsdi.2924 &gt; svr4.8888: udp 20<BR>10&nbsp; 
15.004574 (0.0036)&nbsp;&nbsp;&nbsp;&nbsp; svr4 &gt; bsdi: icmp: svr4 udp port 
8888 unreachable<BR><BR>11&nbsp; 20.001177 (4.9966)&nbsp;&nbsp;&nbsp;&nbsp; 
bsdi.2924 &gt; svr4.8888: udp 20<BR>12&nbsp; 20.004759 
(0.0036)&nbsp;&nbsp;&nbsp;&nbsp; svr4 &gt; bsdi: icmp: svr4 udp port 8888 
unreachable<BR></P></FONT><FONT face=Arial>
<P>&nbsp;</P>
<P><SMALL>Рисунок 6.8 Генерация ICMP ошибки о недоступности порта в ответ на 
TFTP запрос.</SMALL></P>
<P>&nbsp;</P>
<P><SMALL>ICMP ошибка о недоступности порта возвращается немедленно (строка 4). 
Однако TFTP клиент игнорирует ICMP сообщение и посылает следующую UDP датаграмму 
примерно через 5 секунд (строка 5). Это повторяется трижды, перед тем как клиент 
прекращает свои попытки. </SMALL></P>
<P><SMALL>Обратите внимание на то, что ICMP сообщения передаются между хостами 
без номера порта назначения, тогда как каждая 20-байтовая UDP датаграмма выходит 
из указанного порта (2924) в указанный порт (8888). </SMALL></P>
<P><SMALL>Число 20 в конце каждой UDP строки это длина данных в UDP датаграмме. 
В данном примере 20 - это сумма двухбайтного кода операции (opcode) TFTP, 
9-байтного имени (temp.foo) и 9-байтной строки netascii. (На рисунке 15.1 
подробно описано содержимое пакета TFTP.) </SMALL></P>
<P><SMALL>Если мы запустим тот же пример с опцией <A name=t065004></A>-e команды 
tcpdump, то увидим точную длину каждого ICMP сообщения о недоступности порта, 
которое возвращается отправителю. Длина составляет 70 байт. (см. рисунок 6.9).<A 
name=t065005></A></SMALL></P></FONT>
<P align=center><SMALL><IMG height=132 src="t6_9.jpg" 
width=512></SMALL></P><FONT face=Arial>
<P align=center><SMALL>Рисунок 6.9 ICMP сообщение, вернувшееся в нашем примере 
"порт UDP недоступен".</SMALL></P>
<P>&nbsp;</P>
<P><SMALL>Одно из правил, которому подчиняется ICMP, заключается в том, что ICMP 
сообщение об ошибке (см. последнюю колонку на рисунке 6.3) должно включать IP 
заголовок (включая все опции) датаграммы, на которую сгенерирована ошибка. Также 
ICMP сообщение об ошибке содержит, по крайней мере, первые 8 байт из IP 
датаграммы, которые следуют за IP заголовком. В нашем примере первые 8 байт, 
следующие за IP заголовком, содержат UDP заголовок (рисунок 11.2). </SMALL></P>
<P><SMALL>Очень важный факт заключается в том, что UDP заголовок содержит номера 
портов источника и назначения. В данном случае это порт назначения (8888), из-за 
которого было сгенерировано ICMP сообщение о недоступности порта. Номер порта 
источника (2924) может быть использован системой, получившей ICMP сообщение об 
ошибке, чтобы установить соответствие между принятой ошибкой и конкретным 
пользовательским процессом (в данном случае TFTP клиент). </SMALL></P>
<P><SMALL>Одна из причин, по которой IP заголовок датаграммы, которая вызвала 
сообщение об ошибке, посылается обратно, заключается в том, что этот IP 
заголовок содержит поле протокола, которое позволяет ICMP модулю понять, как 
необходимо интерпретировать следующие 8 байт (в данном примере - UDP заголовок). 
Если обратиться к TCP заголовку (см. рисунок 17.2), то мы увидим, что номера 
портов источника и назначения содержатся в первых 8 байтах TCP заголовка. Общий 
формат ICMP сообщений о недоступности показан на рисунке 6.10. <A 
name=t065001></A></SMALL></P></FONT>
<P align=center><SMALL><IMG height=168 src="t6_10.jpg" 
width=513></SMALL></P><FONT face=Arial>
<P align=center><SMALL>Рисунок 6.10 Сообщение о недоступности ICMP.</SMALL></P>
<P>&nbsp;</P>
<P><SMALL>На рисунке 6.3 мы видели, что существует 16 различных ICMP сообщений о 
недоступности с кодами от 0 до 15. ICMP сообщение о недоступности порта имеет 
код 3. На рисунке 6.10 показано, что второе 32-битное слово в ICMP сообщении 
должно быть установлено в 0. Механизм определения транспортного MTU (глава 2, 
раздел <A href="glava2.html#t029000">"Транспортный MTU"</A>) позволяет
маршрутизатору поместить MTU исходящего интерфейса в младшие 16 бит этого 
32-битного значения, когда код равен 4 (<A name=t065007></A>"необходима 
фрагментация, однако установлен бит не фрагментировать "). Мы покажем пример 
подобной ошибки в разделе <A href="glava11.html#t116000">"ICMP ошибки о
недоступности (требуется фрагментация)"</A> главы 11. </SMALL></P>
<P>&nbsp;</P><FONT size=1>
<P></FONT><FONT size=2><FONT color=#0000a0>Правила, по которым действует ICMP, 
позволяют системе вернуть больше чем первые 8 байт раздела данных IP датаграммы, 
которая вызвала ICMP ошибку, однако большинство Berkeley реализаций возвращают 
ровно 8 байт. В <A name=t065008></A>Solaris 2.2, с использованием опции <A 
name=t065009></A>ip_icmp_return_data_bytes, может быть указано, сколько байт 
необходимо возвращать, однако по умолчанию возвращаются первые 64 байта данных 
(приложение E, раздел <A href="glavaE.html#t354000">"Solaris
2.2"</A>).</FONT></P></FONT>
<P>&nbsp;</P><FONT size=3><I><B>
<P><A name=t065010></A>Временная диаграмма работы команды 
tcpdump</P></B></I></FONT>
<P><SMALL>Здесь мы приводим временную диаграмму, соответствующую выводу команды 
<A name=t065011></A>tcpdump, приведенному на рисунке 6.11.<A 
name=t065002></A></SMALL></P></FONT>
<P align=center><SMALL><IMG height=533 src="t6_11.jpg" 
width=478></SMALL></P><FONT face=Arial>
<P align=center><SMALL>Рисунок 6.11 Временная диаграмма запроса TFTP на неверный 
порт.</SMALL></P>
<P>&nbsp;</P>
<P><SMALL>Время на рисунке увеличивается по направлению вниз, а метки, стоящие 
крайними слева на рисунке, соответствуют величинам времени в выводе команды 
tcpdump, приведенном на рисунке 6.8. Метки вверху - это имена хостов и номера 
портов каждой конечной системы. Однако, вертикальное представление времени на 
рисунке не точно соответствует реальному времени. При передаче данных UDP или 
TCP мы показываем пакет с помощью жирной линии. </SMALL></P>
<P><SMALL>Почему <A name=t065013></A>TFTP клиент осуществляет <A 
name=t065014></A>повторную передачу своего запроса после прихода сообщения ICMP? 
Особенность сетевого программирования, присутствующая в системах BSD, 
заключается в том, что пользовательский процесс, использующий UDP, не 
предупреждается о приеме ICMP сообщения на этот сокет, если только процесс не 
установил соединение (connect) к этому сокету. Стандартный TFTP клиент системы 
BSD не выдает connect, поэтому он никогда не получит уведомления о приходе ICMP 
ошибки. </SMALL></P>
<P><SMALL><A name=t065015></A>Также необходимо обратить внимание на то, что при 
работе TFTP клиента используется алгоритм тайм-аутов и повторных передач. TFTP 
клиент просто осуществляет повторную передачу каждые 5 секунд, всего в течение 
25 секунд. Позже мы увидим, что подобный алгоритм протокола TCP значительно 
лучше.</SMALL></P>
<P>&nbsp;</P><FONT size=1>
<P></FONT><FONT size=2><FONT color=#0000a0>Устаревший алгоритм тайм-аутов и 
повторных передач, используемый TFTP клиентом, в настоящее время запрещен <A 
name=t065016></A>Host Requirements RFC. Тем не менее, все три системы в 
описываемой подсети и <A name=t065017></A>Solaris 2.2 до сих пор его используют. 
<A name=t065018></A>AIX 3.2.2 использует <A name=t065019></A>экспотенциальный 
рост тайм-аута, посылая пакеты с интервалом 0, 5, 15 и 35 секунд. В настоящее 
время рекомендуется именно такой способ расчета тайм-аутов. Более подробно мы 
обсудим тайм-ауты в <A href="glava21.html">главе 21</A>.</FONT></P></FONT>
<P>&nbsp;</P>
<P><SMALL>И в заключение, обратите внимание на то, что ICMP сообщения вернулись 
примерно через 3,5 миллисекунды после отправки UDP датаграммы. В <A 
href="glava7.html">главе 7</A> мы увидим, что это примерно соответствует времени
возврата для отклика Ping.</SMALL></P><FONT size=3><U><B>
<P><A name=t066000></A>Обработка ICMP сообщений в 4.4BSD</P></B></U></FONT>
<P><SMALL>Так как ICMP охватывает очень широкий диапазон различных условий, 
начиная от фатальных ошибок и заканчивая информационными сообщениями, каждое 
ICMP сообщение обрабатывается по-своему даже в рамках одной реализации. 
Рисунок&nbsp;6.12 это повтор рисунка 6.3, который показывает обработку возможных 
ICMP сообщений системой <A name=t066002></A>4.4BSD. </SMALL></P>
<P><SMALL>Если в последней колонке указано "ядро", ICMP сообщение обрабатывается 
ядром, если - "пользовательский процесс", это означает, что сообщение передается 
всем пользовательским процессам, которые зарегистрированы в ядре так, что могут 
читать принятые ICMP сообщения. Если подобных пользовательских процессов нет, 
сообщение молча удаляется. (Эти пользовательские процессы также получают копии 
всех других ICMP сообщений, даже если те обрабатываются ядром, однако только 
после того, как ядро обработало сообщение.) Некоторые сообщения полностью 
игнорируются. И в заключение, если в последней колонке находится строка в 
кавычках, то эта строка является сообщением об ошибке Unix, соответствующее 
создавшемуся условию. Некоторые из ошибок мы рассмотрим в следующих главах.<A 
name=t066001></A></SMALL></P>
<P>&nbsp;</P></FONT>
<TABLE border=1 borderColor=#000000 cellPadding=5 cellSpacing=1 width=690>
  <TBODY>
  <TR>
    <TD bgColor=#ffffff vAlign=top width="7%">
      <P align=center><SMALL><FONT face=Arial>тип</FONT></SMALL></P></TD>
    <TD bgColor=#ffffff vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>код</SMALL></FONT></P></TD>
    <TD bgColor=#ffffff vAlign=top width="50%"><FONT face=Arial>
      <P align=center><SMALL>Описание</SMALL></FONT></P></TD>
    <TD bgColor=#ffffff vAlign=top width="36%"><FONT face=Arial>
      <P align=center><SMALL>Кем обрабатывается</SMALL></FONT></P></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>эхо 
      отклик</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>пользовательский 
      процесс</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>3</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>назначение недоступно - 
      destination unreachable:</SMALL></FONT></TD>
    <TD vAlign=top width="36%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>сеть недоступна - 
      network unreachable</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"No route to 
      host"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>1</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>хост недоступен - host 
      unreachable</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"No route to 
      host"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>2</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>протокол недоступен - 
      protocol unreachable</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"Connection 
      refused"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>3</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>порт недоступен - port 
      unreachable</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"Connection 
      refused"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>4</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>необходима 
      фрагментация, но установлен бит DF - fragmentation needed but DF bit set 
      </SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"Message too 
      long"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>5</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>сбой маршрутизация от 
      источника - source route failed</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"No route to 
      host"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>6</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>сеть назначения 
      неизвестна - destination network unknown</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"No route to 
      host"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>7</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>хост назначения 
      неизвестен - destination host unknown</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"No route to 
      host"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>8</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>хост назначения 
      изолирован - source host isolated (obsolete)</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"No route to 
      host"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>9</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>сеть назначения 
      административно закрыта - destination network administratively 
      prohibited</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"No route to 
      host"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>10</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>хост назначения 
      административно закрыт - destination host administratively 
      prohibited</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"No route to 
      host"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>11</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>сеть недоступна для TOS 
      - network unreachable for TOS</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"No route to 
      host"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>12</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>хост недоступен для TOS 
      - host unreachable for TOS</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"No route to 
      host"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>13</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>связь административно 
      закрыта - communication administratively prohibited</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT 
      face=Arial><SMALL>(игнорируется)</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>14</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>нарушено старшинство 
      для хоста - host precedence violation </SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT 
      face=Arial><SMALL>(игнорируется)</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>15</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>старшинство разъединено 
      - precedence cutoff in effect</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT 
      face=Arial><SMALL>(игнорируется)</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>4</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>подавление источника - 
      source quench</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>ядром TCP, игнорируется 
      UDP</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>5</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>перенаправление - 
      redirect:</SMALL></FONT></TD>
    <TD vAlign=top width="36%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>перенаправление в сеть 
      - redirect for network </SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>ядро обновляет таблицу 
      маршрутизации</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>1</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>перенаправление в хост 
      - redirect for host</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>ядро обновляет таблицу 
      маршрутизации</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>2</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>перенаправление для 
      типа сервиса и сети - redirect for type-of-service and 
      network</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>ядро обновляет таблицу 
      маршрутизации</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>3</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>перенаправление для 
      типа сервиса и хоста - redirect for type-of-service and 
    host</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>ядро обновляет таблицу 
      маршрутизации</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>8</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>эхо запрос - echo 
      request</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>ядро генерирует 
      отклик</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>9</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>объявление 
      маршрутизатора - router advertisement</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>пользовательский 
      процесс</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>10</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>запрос к маршрутизатору 
      - router solicitation</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>пользовательский 
      процесс</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>11</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>время истекло - time 
      exceeded: </SMALL></FONT></TD>
    <TD vAlign=top width="36%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>время жизни стало 
      равным 0 в процессе передачи - time-to-live equals 0 during 
      transit</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>пользовательский 
      процесс</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>1</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>время жизни стало 
      равным 0 в процессе повторной сборки - time-to-live equals 0 during 
      reassembly</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>пользовательский 
      процесс</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>12</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>проблемы с параметрами 
      - parameter problem:</SMALL></FONT></TD>
    <TD vAlign=top width="36%">&nbsp;</TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>неверный IP заголовок - 
      IP header bad</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"Protocol not 
      available"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%">&nbsp;</TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>1</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>отсутствует необходимая 
      опция - required option missing</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>"Protocol not 
      available"</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>13</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>запрос временной марки 
      - timestamp request</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>ядро генерирует 
      отклик</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>14</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>отклик с временной 
      маркой - timestamp reply</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>пользовательский 
      процесс</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>15</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>информационный запрос - 
      information request </SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT 
      face=Arial><SMALL>(игнорируется)</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>16</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>информационный отклик - 
      information reply </SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>пользовательский 
      процесс</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>17</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>запрос маски адреса - 
      address mask request</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>ядро генерирует 
      отклик</SMALL></FONT></TD></TR>
  <TR>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>18</SMALL></FONT></P></TD>
    <TD vAlign=top width="7%"><FONT face=Arial>
      <P align=center><SMALL>0</SMALL></FONT></P></TD>
    <TD vAlign=top width="50%"><FONT face=Arial><SMALL>отклик с маской адреса 
      - address mask reply</SMALL></FONT></TD>
    <TD vAlign=top width="36%"><FONT face=Arial><SMALL>пользовательский 
      процесс</SMALL></FONT></TD></TR></TBODY></TABLE><FONT face=Arial>
<P><SMALL>Рисунок 6.12 Обработка ICMP сообщений в <A 
name=t066003></A>4.4BSD.</SMALL></P><FONT size=3><U><B>
<P><A name=t067000></A>Краткие выводы</P></B></U></FONT>
<P><SMALL>В этой главе рассмотрен протокол управления сообщениями Internet 
(Internet Control Message Protocol), который является неотъемлемой частью каждой 
реализации. На рисунке 6.3 приведены все типы ICMP сообщений, большинство из 
которых мы обсудили или обсудим в тексте. </SMALL></P>
<P><SMALL>Мы рассмотрели ICMP запрос маски адреса и соответствующий отклик, а 
также запрос и отклик временной марки. Эти типы ICMP сообщений мы рассмотрели 
более или менее подробно. Они являются типичными сообщениями в форме 
запрос-отклик. Оба имеют идентификатор и номер последовательности в ICMP 
сообщении. Посылающее приложение сохраняет уникальное значение в поле 
идентификатора, чтобы провести различие между откликами для него самого 
(направляемые ему) и откликами для других процессов. Поле номера 
последовательности позволяет клиенту сопоставить запрос с полученным откликом. 
</SMALL></P>
<P><SMALL><A name=t067001></A>Также мы рассмотрели ICMP ошибку недоступности 
порта, которая является наиболее общей ошибкой ICMP. Это позволило нам более 
подробно рассмотреть информацию, которая возвращается в ICMP ошибке: IP 
заголовок и следующие 8 байт из IP датаграммы, которая вызвала генерацию ошибки. 
Эта информация необходима ICMP модулю, принимающему ошибку, для того чтобы 
узнать больше о том, чем была вызвана ошибка. И TCP, и UDP сохраняют номера 
портов источника и назначения в первых 8 байтах своих заголовков именно по этой 
причине. </SMALL></P>
<P><SMALL>В заключение, мы показали строки вывода <A name=t067002></A>tcpdump, 
эту команду мы будем довольно часто использовать в следующих 
главах.</SMALL></P><FONT size=3><I><B>
<P>Упражнения</B></I></FONT><FONT size=1> 
<OL>
  <LI></FONT><FONT size=2>В конце раздела <A href="#t062000">"Типы сообщений 
  ICMP"</A> мы привели 5 специальных условий, при которых сообщение об ошибке 
  ICMP не посылается. Что произойдет, если эти 5 условий не соблюдены, а мы 
  послали широковещательную UDP датаграмму на несоответствующий порт в локальном 
  кабеле? 
  <LI>Прочитайте <A name=t067003></A>Host Requirements RFC [<A 
  name=t067004></A>Braden 1989a], чтобы посмотреть, попадает ли генерация ICMP 
  ошибки о недоступности порта под разделы "должен", "следует" или "может". В 
  каком разделе и на какой странице это можно найти? 
  <LI>Прочитайте RFC 1349 [<A name=t067005></A>Almquist 1992], чтобы посмотреть, 
  как поле <A name=t067006></A>типа сервиса IP (см. рисунок 3.2) должно быть 
  установлено для ICMP. 
  <LI>Если Ваша система имеет команду <A name=t067007></A>netstat, используйте 
  ее, чтобы посмотреть, какой тип ICMP сообщений принимается и 
  посылается.</FONT><FONT size=1> </LI></OL></FONT></FONT>
<P><SMALL><A href="index.html"><IMG border=0 height=20 src="contents.jpg"
width=94></A><A href="glava7.html"><IMG border=0 height=20 src="forward.jpg"
width=68></A><A href="glava5.html"><IMG border=0 height=20 src="back_b.jpg"
width=68></A><A href="index.html"><IMG border=0 height=20 src="index.jpg" 
width=68></A></SMALL></P><FONT size=1>
<P>&nbsp;</P></FONT></div></BODY></HTML>
